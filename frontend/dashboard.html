<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ViruScan AI — Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Changa:wght@500;700&display=swap" rel="stylesheet">
</head>

<body>

<div class="overlay"></div>

<!-- ========== NAVBAR ========== -->
<nav>
  <ul>
    <li><a href="dashboard.html" class="active"><i class="fa-solid fa-house"></i> Home</a></li>
    <li><a href="#" id="dashHelpBtn"><i class="fa-solid fa-circle-question"></i> Help</a></li>
    <li><a href="#" id="contactBtn"><i class="fa-solid fa-envelope"></i> Contact</a></li>
    <li><a href="#" id="historyBtn"><i class="fa-solid fa-book-open"></i> History</a></li>
    <li><a href="#" id="feedbackBtn"><i class="fa-solid fa-star"></i> Feedback</a></li>
    <li><a href="#" id="signOut"><i class="fa-solid fa-right-from-bracket"></i> Sign out</a></li>
  </ul>

  <div class="logo">ViruScan AI</div>
</nav>

<!-- ========== HERO SCAN BOX ========== -->
<section class="scan-section glass">
  <h2>Scan a Website or Application</h2>
  <p>Enter a URL or an application package name</p>

  <div class="scan-box">
    <input type="text" id="scanInput" placeholder="https://example.com OR com.app.name">
    <button id="scanBtn" class="primary"><i class="fa-solid fa-magnifying-glass"></i> Scan</button>
  </div>
</section>

<!-- ========== STATISTICS ========== -->
<section class="stats glass">
  <h2><i class="fa-solid fa-chart-pie"></i> Your Statistics</h2>

  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total Scans</h3>
      <p id="totalScans">0</p>
    </div>

    <div class="stat-card">
      <h3>Safe Results</h3>
      <p id="safeCount">0</p>
    </div>

    <div class="stat-card">
      <h3>Warnings</h3>
      <p id="warnCount">0</p>
    </div>

    <div class="stat-card">
      <h3>Dangerous</h3>
      <p id="dangerCount">0</p>
    </div>
  </div>
</section>

<!-- ========== LAST 5 SCANS ========== -->
<section class="history glass">
  <h2><i class="fa-solid fa-clock-rotate-left"></i> Last 5 Scans</h2>

  <ul id="lastFive"></ul>
</section>

<!-- ========== HELP MODAL DASHBOARD ========== -->
<div id="dashHelpModal" class="modal">
  <div class="modal-card">
    <span class="close-btn" data-close="dashHelpModal">&times;</span>
    <h2>Help & Support</h2>

    <div class="accordion">

      <!-- Item 1 -->
      <div class="acc-item">
        <button class="acc-btn">
          How to scan a website or app?
          <i class="fa-solid fa-chevron-down"></i>
        </button>
        <div class="acc-content">
          <p>
            To scan a website, enter the full URL (e.g., https://example.com).  
            To scan an application, enter its package name (e.g., com.app.name).  
            Then press the Scan button.
          </p>
        </div>
      </div>

      <!-- Item 2 -->
      <div class="acc-item">
        <button class="acc-btn">
          What is the Risk Score?
          <i class="fa-solid fa-chevron-down"></i>
        </button>
        <div class="acc-content">
          <p>
            The AI calculates a Risk Score from 0–100 based on safety indicators.  
            • 0–30 = Safe  
            • 31–70 = Warning  
            • 71–100 = Dangerous
          </p>
        </div>
      </div>

      <!-- Item 3 -->
      <div class="acc-item">
        <button class="acc-btn">
          How to read the results?
          <i class="fa-solid fa-chevron-down"></i>
        </button>
        <div class="acc-content">
          <p>
            The results page shows: label, risk score, reasons for the score,  
            and recommended AI solutions.
          </p>
        </div>
      </div>

      <!-- Item 4 -->
      <div class="acc-item">
        <button class="acc-btn">
          How to fix Failed Scan?
          <i class="fa-solid fa-chevron-down"></i>
        </button>
        <div class="acc-content">
          <p>
            • Check URL format  
            • Ensure package name is correct  
            • Try again later  
            • Check internet connection  
          </p>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Other Modals: Contact, Feedback, History (working) -->
<div id="contactModal" class="modal">
  <div class="modal-card">
    <span class="close-btn" data-close="contactModal">&times;</span>
    <h2>Contact Us</h2>
    <input type="text" id="cName" placeholder="Your Name">
    <input type="email" id="cEmail" placeholder="Your Email">
    <textarea id="cMsg" placeholder="Your Message" rows="4"></textarea>
    <button class="primary" id="sendContact">Send</button>
  </div>
</div>

<div id="feedbackModal" class="modal">
  <div class="modal-card">
    <span class="close-btn" data-close="feedbackModal">&times;</span>
    <h2>Feedback</h2>
    <div class="stars" id="starRating">
      <span class="star" data-value="1">&#9733;</span>
      <span class="star" data-value="2">&#9733;</span>
      <span class="star" data-value="3">&#9733;</span>
      <span class="star" data-value="4">&#9733;</span>
      <span class="star" data-value="5">&#9733;</span>
    </div>
    <textarea id="feedbackText" placeholder="Write your feedback..." rows="3"></textarea>
    <button class="primary" id="submitFeedback">Submit</button>
  </div>
</div>

<div id="historyModal" class="modal">
  <div class="modal-card">
    <span class="close-btn" data-close="historyModal">&times;</span>
    <h2>History</h2>
    <ul id="fullHistory"></ul>
  </div>
</div>

<script>
const API_BASE = "http://127.0.0.1:8000/api";

let users = [];
let feedback = [];
let scans = [];

// Check if user is admin
window.addEventListener('DOMContentLoaded', async () => {
  const isAdmin = localStorage.getItem('isAdmin');
  
  if (!isAdmin) {
    alert('❌ Admin access required');
    window.location.href = 'index.html';
    return;
  }

  // Load all data
  await loadStats();
  await loadUsers();
  await loadFeedback();
  await loadScans();
});

// ========== LOAD DATA FROM BACKEND ==========

async function loadStats() {
  try {
    const response = await fetch(`${API_BASE}/admin/stats`, {
      credentials: 'include'
    });
    
    if (!response.ok) {
      throw new Error('Failed to load stats');
    }

    const data = await response.json();
    
    document.getElementById("countUsers").textContent = data.total_users;
    document.getElementById("countFeedback").textContent = data.total_feedback;
    document.getElementById("countScans").textContent = data.scans_today;
    
  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

async function loadUsers() {
  try {
    const response = await fetch(`${API_BASE}/admin/users`, {
      credentials: 'include'
    });
    
    if (!response.ok) {
      throw new Error('Failed to load users');
    }

    users = await response.json();
    renderUsers();
    
  } catch (error) {
    console.error('Error loading users:', error);
    document.querySelector("#usersTable tbody").innerHTML = 
      '<tr><td colspan="4">Failed to load users</td></tr>';
  }
}

async function loadFeedback() {
  try {
    const response = await fetch(`${API_BASE}/feedback`, {
      credentials: 'include'
    });
    
    if (!response.ok) {
      throw new Error('Failed to load feedback');
    }

    feedback = await response.json();
    renderFeedback();
    
  } catch (error) {
    console.error('Error loading feedback:', error);
    document.querySelector("#fbTable tbody").innerHTML = 
      '<tr><td colspan="4">Failed to load feedback</td></tr>';
  }
}

async function loadScans() {
  try {
    const response = await fetch(`${API_BASE}/history?limit=100`, {
      credentials: 'include'
    });
    
    if (!response.ok) {
      throw new Error('Failed to load scans');
    }

    scans = await response.json();
    renderScans();
    
  } catch (error) {
    console.error('Error loading scans:', error);
    document.querySelector("#scanTable tbody").innerHTML = 
      '<tr><td colspan="5">Failed to load scans</td></tr>';
  }
}

// ========== RENDER TABLES ==========

function renderUsers() {
  const tbody = document.querySelector("#usersTable tbody");
  
  if (users.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4">No users found</td></tr>';
    return;
  }

  tbody.innerHTML = users.map((u, i) => `
    <tr>
      <td>${i + 1}</td>
      <td>${u.full_name}</td>
      <td>${u.email}</td>
      <td>${new Date(u.created_at).toLocaleDateString()}</td>
    </tr>
  `).join("");
}

function renderFeedback() {
  const tbody = document.querySelector("#fbTable tbody");
  
  if (feedback.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4">No feedback found</td></tr>';
    return;
  }

  tbody.innerHTML = feedback.map((f, i) => `
    <tr>
      <td>${i + 1}</td>
      <td>${f.user_name || 'Guest'}</td>
      <td>${"★".repeat(f.rating)}</td>
      <td>${f.comment || 'No comment'}</td>
    </tr>
  `).join("");
}

function renderScans() {
  const tbody = document.querySelector("#scanTable tbody");
  
  if (scans.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5">No scans found</td></tr>';
    return;
  }

  tbody.innerHTML = scans.map((s, i) => `
    <tr>
      <td>${i + 1}</td>
      <td>Anonymous</td>
      <td>${s.target_value.substring(0, 50)}${s.target_value.length > 50 ? '...' : ''}</td>
      <td>${s.label}</td>
      <td>${new Date(s.created_at).toLocaleDateString()}</td>
    </tr>
  `).join("");
}

// ========== PAGE NAVIGATION ==========

document.querySelectorAll(".navlink").forEach(link => {
  link.onclick = () => {
    document.querySelectorAll("section").forEach(s => s.style.display = "none");
    document.querySelectorAll(".navlink").forEach(a => a.classList.remove("active"));
    link.classList.add("active");
    document.getElementById("page-" + link.dataset.page).style.display = "block";
  };
});

// ========== SIGN OUT ==========

document.getElementById("signout").onclick = async () => {
  try {
    await fetch(`${API_BASE}/users/logout`, {
      method: 'POST',
      credentials: 'include'
    });
  } catch (error) {
    console.error('Logout error:', error);
  }
  
  localStorage.clear();
  window.location.href = "index.html";
};

 </script> 
</body>
</html>
